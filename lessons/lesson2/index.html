<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุงูุจุงุญุซ ุงูุนููู ูุงูุฅุดุฑุงู | ููุตุฉ ุชูุงุนููุฉ ุฐููุฉ</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --deep: #16213e;
            --gold: #e2b96f;
            --cream: #faf8f3;
            --success: #10b981;
            --danger: #ef4444;
            --highlight: #6d28d9; /* ุฃุฑุฌูุงูู ุบุงูู ููููุงููู */
        }

        body { 
            font-family: 'Tajawal', Arial, sans-serif; 
            background-color: var(--cream); 
            color: #111827; 
            line-height: 1.8;
            font-size: 18px;
        }
        
        .font-serif { font-family: 'Amiri', serif; }

        .screen { display: none; opacity: 0; transition: opacity 0.5s ease; }
        .screen.active { display: block; opacity: 1; animation: fadeIn 0.6s ease forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        /* ุดุงุดุฉ ุงูุชุฑุญูุจ */
        #welcome-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--deep);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000;
        }
        .welcome-box {
            background: var(--cream); padding: 40px; border-radius: 20px;
            text-align: center; max-width: 500px; width: 90%;
            border-top: 8px solid var(--gold);
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }

        /* ุงููุงุฆูุฉ ุงูุนูููุฉ */
        nav {
            background: #ffffff; border-bottom: 2px solid #e5e7eb;
            display: flex; justify-content: center; gap: 5px; padding: 0 20px;
            overflow-x: auto; white-space: nowrap;
        }
        .nav-btn {
            background: none; border: none; padding: 20px 25px;
            font-size: 19px; font-weight: bold; color: #6b7280;
            cursor: pointer; border-bottom: 4px solid transparent;
            transition: 0.3s; font-family: inherit;
        }
        .nav-btn.active { color: var(--deep); border-bottom-color: var(--gold); }
        .nav-btn.ai-btn { color: #8b5cf6; }

        main { max-width: 1100px; margin: 40px auto; padding: 0 20px; }
        
        .section-title { font-size: 34px; color: var(--deep); margin-bottom: 25px; border-bottom: 3px solid var(--gold); display: inline-block; padding-bottom: 10px; font-weight: bold;}
        .card { background: #ffffff; border-radius: 15px; padding: 35px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); margin-bottom: 30px; border-right: 6px solid var(--deep); }
        
        .keyword-highlight { color: var(--highlight); font-weight: 900; font-size: 0.85em; margin-right: 8px;}

        /* ุงูุฎุฑูุทุฉ ุงูุจุตุฑูุฉ (Solid Tree) */
        .tree ul { padding-top: 20px; position: relative; display: flex; justify-content: center; padding-right: 0;}
        .tree li { float: right; text-align: center; list-style-type: none; position: relative; padding: 20px 15px 0 15px; }
        .tree li::before, .tree li::after { content: ''; position: absolute; top: 0; right: 50%; border-top: 3px solid var(--deep); width: 50%; height: 20px; }
        .tree li::after { right: auto; left: 50%; border-left: 3px solid var(--deep); }
        .tree li:only-child::after, .tree li:only-child::before { display: none; }
        .tree li:only-child { padding-top: 0; }
        .tree li:first-child::before, .tree li:last-child::after { border: 0 none; }
        .tree li:last-child::before { border-right: 3px solid var(--deep); border-radius: 0 8px 0 0; }
        .tree li:first-child::after { border-radius: 8px 0 0 0; }
        .tree ul ul::before { content: ''; position: absolute; top: 0; right: 50%; border-left: 3px solid var(--deep); width: 0; height: 20px; }
        .tree-node { border: 3px solid var(--deep); padding: 15px 25px; border-radius: 12px; background: #ffffff; display: inline-block; font-size: 20px; font-weight: bold; color: var(--deep); font-family: 'Amiri', serif; z-index: 10; position: relative; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .tree-root { background: var(--deep); color: var(--gold); border-color: var(--gold); font-size: 24px; }

        /* ุงูุจุทุงูุงุช ุงูููุงุจุฉ */
        .flashcards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 25px; }
        .flip-card { height: 240px; perspective: 1000px; cursor: pointer; }
        .flip-card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; }
        .flip-card.flipped .flip-card-inner { transform: rotateY(180deg); }
        .flip-card-front, .flip-card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 15px; display: flex; align-items: center; justify-content: center; padding: 25px; box-shadow: 0 6px 12px rgba(0,0,0,0.08); }
        .flip-card-front { background: white; border: 3px solid var(--gold); }
        .flip-card-back { background: var(--deep); color: white; transform: rotateY(180deg); border: 3px solid var(--gold); }

        /* ุฃุฒุฑุงุฑ ุงูุงุฎุชุจุงุฑ */
        .quiz-btn { background: #ffffff; border: 2px solid #e5e7eb; padding: 20px; border-radius: 12px; font-size: 20px; text-align: right; cursor: pointer; transition: 0.3s; width: 100%; margin-bottom: 15px; font-weight: bold;}
        .quiz-btn.correct { border-color: var(--success); background: #ecfdf5; color: #065f46; }
        .quiz-btn.wrong { border-color: var(--danger); background: #fef2f2; color: #991b1b; }

        /* ุงูุฏุฑุฏุดุฉ */
        .chat-container { display: flex; flex-direction: column; height: 500px; background: #ffffff; border-radius: 12px; border: 2px solid #e5e7eb; padding: 25px; overflow-y: auto; margin-bottom: 15px; }
        .chat-msg { margin-bottom: 15px; padding: 12px 20px; border-radius: 15px; max-width: 85%; font-size: 18px; }
        .ai-msg { background: #f3f4f6; color: var(--deep); align-self: flex-start; border-bottom-right-radius: 0; border: 1px solid #e5e7eb; }
        .user-msg { background: var(--deep); color: white; align-self: flex-end; border-bottom-left-radius: 0; }
    </style>
</head>
<body>

    <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;"></iframe>

    <!-- 1. ุดุงุดุฉ ุงูุชุฑุญูุจ -->
    <div id="welcome-screen" class="screen active">
        <div class="welcome-box">
            <h1 class="font-serif text-4xl font-bold mb-4" style="color:var(--deep)">ุงููุญุงุถุฑุฉ ุงูุซุงููุฉ</h1>
            <h2 class="text-2xl mb-8" style="color:var(--gold)">ุงูุจุงุญุซุ ูุตูุงุชูุ ูุงูุฅุดุฑุงู ุงูุนููู</h2>
            <input type="text" id="studentNameInput" class="w-full p-4 border-2 rounded-xl text-center text-xl mb-6 outline-none focus:border-gold" placeholder="ุฃุฏุฎู ุงุณูู ุงูุฑุจุงุนู ููุจุฏุก...">
            <button onclick="startLesson()" class="w-full bg-gold p-4 rounded-xl text-2xl font-bold text-deep hover:opacity-90 transition">ุจุฏุก ุงูุฏุฑุณ ูุงูุชูููุช</button>
        </div>
    </div>

    <!-- 2. ุงููููู ุงูุฑุฆูุณู -->
    <div id="main-app" class="screen">
        <header class="bg-[#16213e] text-white p-4 flex justify-between items-center sticky top-0 z-50">
            <div class="font-serif text-2xl font-bold text-[#e2b96f]">ุงูุฎูุงุตุฉ ูู ุงูุจุญุซ ุงูุนููู</div>
            <div class="flex gap-4">
                <span class="bg-white/10 px-4 py-1 rounded-full text-sm">ุงูุทุงูุจ: <span id="display-name" class="text-gold"></span></span>
                <span class="bg-white/10 px-4 py-1 rounded-full text-sm">ุงูุฒูู: <span id="display-time" class="text-gold">00:00</span></span>
            </div>
        </header>

        <nav>
            <button class="nav-btn active" onclick="switchTab('content', this)">ุงููุงุฏุฉ ุงูุนูููุฉ</button>
            <button class="nav-btn" onclick="switchTab('map', this)">ุงูุฎุฑูุทุฉ ุงูุจุตุฑูุฉ</button>
            <button class="nav-btn" onclick="switchTab('review', this)">ุงููุฑุงุฌุนุฉ</button>
            <button class="nav-btn ai-btn" onclick="switchTab('ai-tutor', this)">โจ ุงููุณุงุนุฏ ุงูุฐูู</button>
            <button class="nav-btn" onclick="switchTab('quiz', this)">ุงูุงุฎุชุจุงุฑ ุงูููุงุฆู</button>
        </nav>

        <main>
            <!-- ุงููุณู 1: ุงููุงุฏุฉ ุงูุนูููุฉ -->
            <section id="tab-content" class="screen active">
                <h2 class="section-title font-serif">ุงูุจุงุญุซ ุงูุฃุตูู</h2>
                <div class="card border-r-8 border-gold">
                    <p class="text-2xl font-medium mb-4">ูู ุดุฎุต ุชูุงูุฑุช ููู ุงูุงุณุชุนุฏุงุฏุงุช ุงููุทุฑูุฉ ูุงูููุณูุฉ ูุงูุนูููุฉ ุงูุชู ุชุคููู ููููุงู ุจุจุญุซ ุนููู.</p>
                    <p class="text-2xl font-bold text-deep">ุงูุจุงุญุซ ุงูุฃุตูู: ูู ุงูุฐู ูุชุทูุน ุฅูู ุงููุฌูููุ ููุจุญุซ ุนู ุงูุฌุฏูุฏุ ููุชููุฒ ุจุงููุฑููุฉ ุงูููุฑูุฉุ ูููุชูู ุงููุฏุฑุฉ ุนูู ุชูุธูู ุงููุนูููุงุช.</p>
                </div>

                <h2 class="section-title font-serif mt-10">ุตูุงุช ุงูุจุงุญุซ (14 ุตูุฉ)</h2>
                <div id="traits-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
            </section>

            <!-- ุงููุณู 2: ุงูุฎุฑูุทุฉ ุงูุจุตุฑูุฉ (Solid Tree) -->
            <section id="tab-map" class="screen">
                <h2 class="section-title font-serif">ุงููููู ุงูููุงูููู</h2>
                <div class="card overflow-x-auto py-10">
                    <div class="tree">
                        <ul>
                            <li>
                                <div class="tree-node tree-root">ุฃุฑูุงู ุงูุจุญุซ ุงูุนููู ุงูุฃุณุงุณูุฉ</div>
                                <ul>
                                    <li>
                                        <div class="tree-node">ุงูุจุงุญุซ ุงูุฃุตูู</div>
                                        <ul>
                                            <li><div class="tree-node text-base font-sans">ุชุฃููู ุนููู ูุณุจู</div></li>
                                            <li><div class="tree-node text-base font-sans">ุชุทูุน ูููุฌููู</div></li>
                                            <li><div class="tree-node text-base font-sans">ูุฑููุฉ ูุชูุธูู</div></li>
                                        </ul>
                                    </li>
                                    <li>
                                        <div class="tree-node" style="border-color: var(--gold);">ุตูุงุช ุงูุจุงุญุซ (14)</div>
                                        <ul>
                                            <li><div class="tree-node text-base font-sans" style="border-color: var(--gold);">ุงูุตุจุฑ (ุงููููุฏ)</div></li>
                                            <li><div class="tree-node text-base font-sans" style="border-color: var(--gold);">ุงูุชุซุจุช ูุงูููุถูุนูุฉ</div></li>
                                            <li><div class="tree-node text-base font-sans" style="border-color: var(--gold);">ุงูุชูุงุถุน ูุงูุชุถุงู ุงูููุณ</div></li>
                                        </ul>
                                    </li>
                                    <li>
                                        <div class="tree-node">ุงูุฅุดุฑุงู ุงูุนููู</div>
                                        <ul>
                                            <li><div class="tree-node text-base font-sans">ุชูุฌูู ูููุฌู</div></li>
                                            <li><div class="tree-node text-base font-sans">ูููุฉ ุชุตูุน ุงูุจุงุญุซูู</div></li>
                                            <li><div class="tree-node text-base font-sans">ุชูุงุตู ูุนูุงู ููุจุงุฏุฑุฉ</div></li>
                                        </ul>
                                    </li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                </div>
            </section>

            <!-- ุงููุณู 3: ุงููุฑุงุฌุนุฉ -->
            <section id="tab-review" class="screen">
                <h2 class="section-title font-serif">ูุฑุงุฌุนุฉ ุณุฑูุนุฉ (14 ุจุทุงูุฉ)</h2>
                <div id="flashcards-container" class="flashcards-grid"></div>
            </section>

            <!-- ุงููุณู 4: ุงููุณุงุนุฏ ุงูุฐูู (ุฐูุงุก Gemini ุงูุญูููู) -->
            <section id="tab-ai-tutor" class="screen">
                <h2 class="section-title font-serif text-purple-600 border-purple-600">โจ ุงููุณุงุนุฏ ุงูุฃูุงุฏููู ุงูุฐูู</h2>
                <div class="card border-purple-500">
                    <div class="chat-container" id="chat-history">
                        <div class="chat-msg ai-msg">ูุฑุญุจุงู! ุฃูุง ูุฏุนูู ุจู Gemini AI. ููุฏ ูุฑุฃุช ูุงุฏุชู ุงูุนูููุฉ ุจุงููุงูู ููุณุชุนุฏ ูุดุฑุญ ุฃู ููุทุฉุ ุชุนุฏุงุฏ ุงูุตูุงุชุ ุฃู ุชูุถูุญ ููุงููู ุงูุฅุดุฑุงู. ููู ุฃุณุงุนุฏู ุงููููุ</div>
                    </div>
                    <div class="flex gap-2">
                        <input type="text" id="ai-input" class="flex-1 p-4 border-2 rounded-xl outline-none focus:border-purple-500" placeholder="ุงุณุฃููู ุฃู ุดูุก (ูุซูุงู: ุนุฏุฏ ูู ุฃูู ุตูุงุช ุงูุจุงุญุซุ)..." onkeypress="if(event.key === 'Enter') askAI()">
                        <button onclick="askAI()" id="send-btn" class="bg-purple-600 text-white px-8 rounded-xl font-bold transition hover:bg-purple-700">ุฅุฑุณุงู</button>
                    </div>
                </div>
            </section>

            <!-- ุงููุณู 5: ุงูุงุฎุชุจุงุฑ -->
            <section id="tab-quiz" class="screen">
                <div id="quiz-area" class="card">
                    <div class="flex justify-between font-bold mb-8 text-xl">
                        <span id="quiz-progress" class="text-gray-500">ุงูุณุคุงู 1 ูู 20</span>
                        <span class="text-gold">ุงูุฏุฑุฌุฉ: <span id="quiz-score">0</span></span>
                    </div>
                    <div class="flex items-start gap-4 mb-10">
                        <span class="text-3xl text-gold">โ</span>
                        <div id="question-text" class="text-2xl font-bold text-deep leading-relaxed"></div>
                    </div>
                    <div id="options-area" class="grid grid-cols-1 gap-4"></div>
                </div>
                <div id="result-area" class="card screen text-center py-20">
                    <div class="text-8xl mb-6">๐</div>
                    <h2 id="result-title" class="text-4xl font-bold mb-4"></h2>
                    <p class="text-xl text-gray-500 mb-8">ุฏุฑุฌุชู ุงูููุงุฆูุฉ ูู:</p>
                    <div class="text-7xl font-bold text-deep mb-10"><span id="final-score"></span> / 20</div>
                    <div class="bg-green-100 text-green-800 p-4 rounded-xl inline-block border-2 border-green-500 font-bold">โ ุชู ุงุนุชูุงุฏ ุงููุชูุฌุฉ ูุฅุฑุณุงููุง ููุฃุณุชุงุฐ.</div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // --- ุฅุนุฏุงุฏุงุช ุงูุฃูุงู (Base64) ---
        // ุถุน ุงููุต "ุงููุดูุฑ" ุงููุงุชุฌ ูู ุงููููุน ููุง ุจูู ุนูุงูุชู ุงูุชูุตูุต
        const ENCODED_KEY = "QUl6YVN5QndlRnVud0dyWkdEeHRyb2FyQlotUVhkMWJXVUFJU2JV"; 

        const GOOGLE_FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSfdYy7qS_r7pP9BFVY2aVKSrZpZk3Vh1S4PoP-2CId16cP6Zg/formResponse";
        const ENTRIES = { name: "entry.1250768814", score: "entry.289736692", extra: "entry.809300628" };

        const TRAITS_DATA = [
            { t: "1. ุงูุฑุบุจุฉ", k: "(ุงูุฏุงูุน ุงูุฏุงุฎูู)", d: "ุฃู ูุชููููุง ููุดุนุฑ ููุณู ุจุซูุฑุฉ ุงูุจุญุซ ุฅู ูู ุชูู ูููุฉ ูู ุงูุจุฏุงูุฉ.", c: "#fffbeb" },
            { t: "2. ุงูุตุจุฑ", k: "(ูููุฏ ุงูุจุงุญุซ)", d: "ุนุฏุฉ ุงูุจุงุญุซ ููููุฏู ุงูุฐู ูุง ููุถุจุ ููุตุจุฑ ุนูู ุงููุฑุงุฌุน ูุงูุฃุณูุงุฑ ูุงููุดุฑู.", c: "#eff6ff" },
            { t: "3. ุงูุฅูุตุงู", k: "(ุงูุฃูุงูุฉ ูุงูุชุฌุฑุฏ)", d: "ุงูุฃูุงูุฉ ูู ุงููููุ ูุชุฑู ุงูุงุณุชุณูุงู ููุนูุงุฑุถ ุงูููุณูุฉ (ูุงูุบุถุจ ูุงูุฑุถุง).", c: "#fdf2f8" },
            { t: "4. ุณูุงูุฉ ุงูุฐูู", k: "(ุฃุฏุจ ุงูููุฏ)", d: "ุฅุญุณุงู ุงูููุฏ ูุงููุฃุฎุฐ ุจุนูุฏุงู ุนู ุงูุงุณุชูุฒุงุฒ ูุงูุนุจุงุฑุงุช ุงูุฌุงููุฉ.", c: "#ecfdf5" },
            { t: "5. ุงูุนูููุฉ ุงูููุธูุฉ", k: "(ุงูุชูุณูู ูุงูุชุจููุจ)", d: "ูุง ูุฌุงู ููููุถูุ ุจู ูุฌุจ ุญุณู ุงูุชุจููุจ ูุนูู ูุชูุงุณู.", c: "#f5f3ff" },
            { t: "6. ุนูู ุงูุชูููุฑ", k: "(ุงูุบูุต ูู ุงูุฃุนูุงู)", d: "ุงูุชุฎูู ูู ุงูุฃุนูุงู ูุญูู ููู ุฏุงุฆูุงู ูุชุฏููู ุงูููุญูุธุงุช ูุฌุฃุฉ.", c: "#fff7ed" },
            { t: "7. ุงููุทูุฉ", k: "(ุงูุชูุจู ููุชูุงุตูู)", d: "ุงูุชูุจู ููู ุชูุตูู ููู ุตุบูุฑุฉ ููุจูุฑุฉ ูุชุฑุงุจุท ุงูุจุญุซ.", c: "#f0f9ff" },
            { t: "8. ุงูุชุซุจุช", k: "(ุงูููุฒุงู ุงูุฏููู)", d: "ูุฒู ุงูุฃููุฑ ุจููุฒุงู ุฏููู ูุจู ูุจูููุงุ ุจุฎูุงู ุงูุดู ุงููุฑุถู.", c: "#fefce8" },
            { t: "9. ุงููุจุงุฏุฑุฉ", k: "(ุงูุชูุงุฒ ุงููุฑุต)", d: "ุงูุชูุงุฒ ุงููุฑุตุ ูุงูุณุฑุนุฉ ุงูุชู ุชุนูู ุนุฏู ุงูุชุจุงุทุค ูููุณ ุงูุนุฌูุฉ ุงููุฐูููุฉ.", c: "#f7fee7" },
            { t: "10. ุงูุญุงูุธุฉ ุงููุงุนูุฉ", k: "(ุฑุจุท ุงููุงุถู ุจุงูุญุงุถุฑ)", d: "ุฌูุน ูุง ููุฑุฃ ูุฏููุงู ุจุญุฏูุซู ูููุน ุชุดุชุช ุงูุจุญุซ ูุชูุฑุงุฑู.", c: "#fdf4ff" },
            { t: "11. ูุชุงุจุนุฉ ุงูุฌุฏูุฏ", k: "(ุงูุงุทูุงุน ุงููุณุชูุฑ)", d: "ุงูุงุทูุงุน ุงููุณุชูุฑ ุงูุฏุงุฆู ูู ููุฏุงู ุงูุชุฎุตุต.", c: "#f0fdfa" },
            { t: "12. ุงูุงุณุชูุชุงุน ุจุงูุจุญุซ", k: "(ุงููุฐุฉ ุงูุนูููุฉ)", d: "ูุฐุฉ ุนูููุฉ ุชููู ุงููุฐุงุช ุงูุญุณูุฉ (ููุง ูุงู ุงูุดุงูุนู ูู ุณูุฑู ููุนููู).", c: "#fef2f2" },
            { t: "13. ูุฒูู ุงูุชูุงุถุน", k: "(ุฅูุจุงุฑ ุงูุนููุงุก)", d: "ุฅูุจุงุฑ ุงูุนููุงุก ูุงูุชุถุงู ุงูููุณ (ูููุง ุฒุฏุช ุนููุงู ุฒุงุฏูู ุนููุงู ุจุฌููู).", c: "#f8fafc" },
            { t: "14. ุงูุชูุงุณ ุงูุจุฑูุฉ", k: "(ุณูุงูุฉ ุงูููุฉ)", d: "ุจุณูุงูุฉ ุงูููุฉุ ูุฅุนุงูุฉ ุงูุฒููุงุก ููุณุงุนุฏุชูู ุฏูู ุจุฎู ุจุงููุนูููุงุช.", c: "#faf5ff" }
        ];

        const QUESTIONS = [
            { q: "ูู ูู ุงูุจุงุญุซ ุงูุฃุตูู ูููุงู ูููุงุฏุฉุ", opts: ["ุงูุฐู ูููู ููุงู ุงูุณุงุจููู ุญุฑููุงู", "ุงูุฐู ูุชุทูุน ุฅูู ุงููุฌููู ููุจุญุซ ุนู ุงูุฌุฏูุฏ", "ุงูุฐู ูุชุฌูุจ ุงููุฑุงุกุฉ ุงููุทููุฉ", "ุงูุฐู ูุญูุธ ุงููุชุจ ุนู ุธูุฑ ููุจ"], ans: 1 },
            { q: "ูุง ุงูุฐู ููุตู ุจุฃูู 'ุนุฏุฉ ุงูุจุงุญุซ ููููุฏู ุงูุฐู ูุง ููุถุจ'ุ", opts: ["ุงููุงู", "ุงูุตุจุฑ", "ุงููุฑุงุฌุน", "ุงููุดุฑู ุงูุนููู"], ans: 1 },
            { q: "ุณูุงูุฉ ุงูุฐูู ูู ุงูุจุญุซ ุชุนูู:", opts: ["ุงููุฌุงููุฉ ุงูููุฑุทุฉ", "ุงูููุฏ ุจุนูุฏุงู ุนู ุงูุงุณุชูุฒุงุฒ ูุงูุนุจุงุฑุงุช ุงูุฌุงููุฉ", "ุงุณุชุฎุฏุงู ุงูุนุจุงุฑุงุช ุงููุนูุฏุฉ", "ุงูุฑุฏ ุงููุงุณู ูุงูุญุงุฏ"], ans: 1 },
            { q: "ุงูุดู ุงูุนููู (ุงูุชุซุจุช) ูู ุงูุจุญุซ ูุนุชุจุฑ:", opts: ["ูุฑุถุงู ููุณูุงู", "ุฅุถุงุนุฉ ููููุช", "ุถุฑูุฑุฉ ููุฒู ุงูุฃููุฑ ุจููุฒุงู ุฏููู", "ุชุดูููุงู ูู ุงููุณููุงุช"], ans: 2 },
            { q: "ูุฒูู ุงูุชูุงุถุน ููุฑุซ ุงูุจุงุญุซ:", opts: ["ุงูุถุนู", "ุฅูุจุงุฑ ุงูุนููุงุก ูุงูุชุถุงู ุงูููุณ", "ุงูุฎูู ูู ุงููุดุฑ", "ุงูุชูุงุณู"], ans: 1 },
            { q: "ุงูุฅุดุฑุงู ุงูุนููู ููุนุฑูู ุจุฃูู:", opts: ["ุนูู ุฅุฏุงุฑู ุจุญุช", "ุชูุฌูู ูููุฌู ููููุฉ ุตุนุจุฉ ุชุตูุน ุงูุจุงุญุซูู", "ูุฑุงุฌุนุฉ ูุบููุฉ ููุท", "ุชูุณูู ุงูุบูุงู"], ans: 1 },
            { q: "ูุง ูุงุฆุฏุฉ 'ุงูุญุงูุธุฉ ุงููุงุนูุฉ'ุ", opts: ["ููุงุณุชุบูุงุก ุนู ุงููุฑุงุฌุน", "ููุชูุงุฎุฑ ุจุงููุนูููุงุช", "ูุฑุจุท ุงููุงุถู ุจุงูุญุงุถุฑ ูููุน ุงูุชุดุชุช", "ูุชุณุฑูุน ุงูุทุจุงุนุฉ"], ans: 2 },
            { q: "ููู ูุญูู ุงูุจุงุญุซ 'ุงูููุถูุนูุฉ ูุงูุฅูุตุงู'ุ", opts: ["ุจููุฏ ุงูุฌููุน ุจุญุฏุฉ", "ุจุงูุฃูุงูุฉ ูู ุงูููู ูุชุฑู ุงูุนูุงุฑุถ ุงูููุณูุฉ", "ุจุงูุงุนุชูุงุฏ ุนูู ุงูุฑุฃู ุงูุดุฎุตู", "ุจุชุฌูุจ ุงููุตุงุฏุฑ"], ans: 1 },
            { q: "ูู ุตูุงุช ุงููุดุฑู ุงูุนููู ุงููุงุฌุญ:", opts: ["ุงูุชุนุงูู", "ุงูุชูุงุถุน ูุงููุจุงุฏุฑุฉ ูุญุณู ุงูุชูุงุตู", "ุชุฃุฎูุฑ ุงูุฑุฏูุฏ", "ุฑูุถ ุงูุฃููุงุฑ ุงูุฌุฏูุฏุฉ"], ans: 1 },
            { q: "ุตูุฉ 'ุงูุฑุบุจุฉ' ุชุนูู:", opts: ["ุงูุฏุงูุน ุงูุฏุงุฎูู ููุจุญุซ", "ุฑุบุจุฉ ุงููุดุฑู ูู ุงูุทุงูุจ", "ุฑุบุจุฉ ุงูุฌุงูุนุฉ ูู ุงูุจุญุซ", "ุงูุฑุบุจุฉ ูู ุงููุงู"], ans: 0 },
            { q: "ูุชุงุจุนุฉ ุงูุฌุฏูุฏ ูู ููุฏุงู ุงูุชุฎุตุต ุชุญูู ุงูุจุงุญุซ ูู:", opts: ["ุงูุชุนุจ", "ุชูุฑุงุฑ ููุถูุน ูุฏ ุชู ุจุญุซู", "ุงูุฃุณุฆูุฉ ุงูุตุนุจุฉ", "ุงูุงูุชูุงุฏ ุงููุบูู"], ans: 1 },
            { q: "ูุตู ุงูุดุงูุนู ูุฐุฉ ุงูุจุญุซ ุจุฃููุง ุฃูุฐ ูู:", opts: ["ุงููุงู", "ุงูููู", "ูุตู ุบุงููุฉ ูุทูุจ ุนูุงู", "ุงูุณูุฑ"], ans: 2 },
            { q: "ุงููุจุงุฏุฑุฉ ูู ุงูุจุญุซ ุงูุนููู ุชุนูู:", opts: ["ุงูุนุฌูุฉ", "ุนุฏู ุงูุชุจุงุทุค ูุงูุชูุงุฒ ุงููุฑุต", "ุงูุจุฏุก ุจุนุฏุฉ ุฃุจุญุงุซ", "ุชุฃุฌูู ุงูุนูู"], ans: 1 },
            { q: "ุงูุจุฑูุฉ ูู ุงูุจุญุซ ุชูุชูุณ ุจู:", opts: ["ุงูุนุฒูุฉ", "ุณูุงูุฉ ุงูููุฉ ูุฅุนุงูุฉ ุงูุฒููุงุก", "ุชุบููุฑ ุงูุฎุท", "ุชุฑู ุงููุดุฑู"], ans: 1 },
            { q: "ุฎุทูุฑุฉ ุชุฃุฎุฑ ุงููุดุฑู ุชููู ูู:", opts: ["ุถูุงุน ููุช ุงูุทุงูุจ ููุทุนู ุนู ุจุญุซู", "ุฒูุงุฏุฉ ุฌูุฏุฉ ุงูุจุญุซ", "ุชูุฑูู ุงูุทุงูุจ", "ูุง ููุฌุฏ ุฎุทูุฑุฉ"], ans: 0 },
            { q: "ุงูุชุฃููู ุงูุนููู ุงููุณุจู ููุจุงุญุซ ูู:", opts: ["ูุทูุจ ุซุงููู", "ูุทูุจ ุฃุณุงุณ ูุชูููู ุดุฎุตูุชู", "ูุถูุนุฉ ููููุช", "ููุนุจุงูุฑุฉ ููุท"], ans: 1 },
            { q: "ุงููุทูุฉ ูุฏูุฉ ุงูููุงุญุธุฉ ุชุนูู:", opts: ["ุงูุชูุจู ููู ุชูุตูู ูุชุฑุงุจุท ุงูุจุญุซ", "ุชุตุญูุญ ุงูุฅููุงุก", "ุชูุณูู ุงูุฎุท", "ุนุฏุฏ ุงูุตูุญุงุช"], ans: 0 },
            { q: "ุงูุนูููุฉ ุงูููุธูุฉ ุชูุฏู ุฅูู:", opts: ["ุชุทููู ุงูุจุญุซ", "ุนูู ูุชูุงุณู ุจุนูุฏ ุนู ุงูููุถู", "ุฅุฑุถุงุก ุงููุดุฑู", "ุชูููู ุงููุฑุงุฌุน"], ans: 1 },
            { q: "ุชูุฑุงุฑ ุงุนุชุฐุงุฑุงุช ุงููุดุฑู ุชุคุฏู ูู:", opts: ["ููุฏุงู ุญูุงุณ ุงูุทุงูุจ", "ุชุญุณูู ุงูุจุญุซ", "ุฒูุงุฏุฉ ุงูุซูุฉ", "ูุง ุดูุก"], ans: 0 },
            { q: "ุนูู ุงูุชูููุฑ ูุชุทูุจ ูู ุงูุจุงุญุซ:", opts: ["ุงูุชุฎูู ูู ุงูุดูุงุบู ูุญูู ููู ุฏุงุฆูุงู", "ูุซุฑุฉ ุงูุณูุฑ", "ูุซุฑุฉ ุงูุฃูู", "ุงูููุงุด ุงูุญุงุฏ"], ans: 0 }
        ];

        let state = { name: "", start: 0, timer: null, q: 0, score: 0, timeStr: "00:00" };

        function startLesson() {
            const input = document.getElementById('studentNameInput').value.trim();
            if (input.split(/\s+/).length < 3) return;
            state.name = input;
            document.getElementById('display-name').textContent = input;
            document.getElementById('welcome-screen').classList.remove('active');
            setTimeout(() => {
                document.getElementById('welcome-screen').style.display = 'none';
                document.getElementById('main-app').classList.add('active');
                state.start = Date.now();
                state.timer = setInterval(updateTimer, 1000);
                loadQuestion();
                initTraits();
                initReview();
            }, 500);
        }

        function updateTimer() {
            const sec = Math.floor((Date.now() - state.start) / 1000);
            state.timeStr = `${Math.floor(sec/60).toString().padStart(2,'0')}:${(sec%60).toString().padStart(2,'0')}`;
            document.getElementById('display-time').textContent = state.timeStr;
        }

        function switchTab(id, btn) {
            document.querySelectorAll('main > section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + id).classList.add('active');
            btn.classList.add('active');
        }

        function initTraits() {
            const grid = document.getElementById('traits-grid');
            TRAITS_DATA.forEach(t => {
                const div = document.createElement('div');
                div.className = "p-6 rounded-2xl shadow-sm border border-gray-100 transform hover:-translate-y-1 transition";
                div.style.backgroundColor = t.c;
                div.innerHTML = `<h3 class="font-bold text-2xl mb-2 text-[#16213e]">${t.t} <span class="keyword-highlight">${t.k}</span></h3><p class="text-xl font-medium">${t.d}</p>`;
                grid.appendChild(div);
            });
        }

        function initReview() {
            const cont = document.getElementById('flashcards-container');
            QUESTIONS.slice(0, 14).forEach((q, idx) => {
                const card = document.createElement('div');
                card.className = "flip-card";
                card.onclick = () => card.classList.toggle('flipped');
                card.innerHTML = `
                    <div class="flip-card-inner">
                        <div class="flip-card-front text-xl font-bold px-4">${q.q}</div>
                        <div class="flip-card-back text-xl font-bold px-4">${q.opts[q.ans]}</div>
                    </div>`;
                cont.appendChild(card);
            });
        }

        // --- ูุญุฑู ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุงูุญูููู ---
        const lessonContext = `
            ุณูุงู ุงูุฏุฑุณ: ุงููุญุงุถุฑุฉ ุงูุซุงููุฉ ูู ุงูุจุญุซ ุงูุนููู.
            ููุถูุน ุงูุฏุฑุณ: ุชุนุฑูู ุงูุจุงุญุซ ุงูุฃุตููุ ุตูุงุช ุงูุจุงุญุซ ุงูู 14ุ ูุงูุฅุดุฑุงู ุงูุนููู.
            ุงูุจุงุญุซ ุงูุฃุตูู: ูุชุทูุน ูููุฌูููุ ูุจุญุซ ุนู ุงูุฌุฏูุฏุ ูุฑููุฉ ููุฑูุฉุ ุชูุธูู ูุนูููุงุช.
            ุงูุตูุงุช: ุงูุฑุบุจุฉุ ุงูุตุจุฑ (ูููุฏ ุงูุจุงุญุซ)ุ ุงูุฅูุตุงู ูุงูููุถูุนูุฉุ ุณูุงูุฉ ุงูุฐูู (ุฃุฏุจ ุงูููุฏ)ุ ุงูุนูููุฉ ุงูููุธูุฉุ ุนูู ุงูุชูููุฑุ ุงููุทูุฉุ ุงูุชุซุจุช (ุงูุดู ุงูุนููู)ุ ุงููุจุงุฏุฑุฉุ ุงูุญุงูุธุฉ ุงููุงุนูุฉุ ูุชุงุจุนุฉ ุงูุฌุฏูุฏุ ุงูุงุณุชูุชุงุน ุจุงูุจุญุซ (ูุฐุฉ ุนูููุฉ)ุ ูุฒูู ุงูุชูุงุถุนุ ุงูุชูุงุณ ุงูุจุฑูุฉ.
            ุงูุฅุดุฑุงู: ุชูุฌูู ูุชุฎุตุตุ ูููุฉ ุชุตูุน ุงูุจุงุญุซููุ ูุชุทูุจ ุชูุงุถุน ูุญูู ุงููุดุฑู ูุนุฏู ุฅุถุงุนุฉ ููุช ุงูุทุงูุจ.
        `;

        async function askAI() {
            const input = document.getElementById('ai-input');
            const question = input.value.trim();
            if (!question) return;

            const chat = document.getElementById('chat-history');
            chat.innerHTML += `<div class="chat-msg user-msg">${question}</div>`;
            input.value = ""; chat.scrollTop = chat.scrollHeight;

            const loading = document.createElement('div');
            loading.className = "chat-msg ai-msg italic";
            loading.textContent = "ุฌุงุฑู ุงูุชูููุฑ...";
            chat.appendChild(loading);

            try {
                // ูู ุงูุชุดููุฑ ุจุฑูุฌูุงู ูุญุธุฉ ุงูุทูุจ
                const decodedKey = atob(ENCODED_KEY);
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${decodedKey}`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `ุฃุฌุจ ุจุตูุชู ูุณุงุนุฏ ุฃูุงุฏููู ููุฏุฑุณ ุงูุชุงูู ููุท: ${lessonContext}. ุงูุณุคุงู: ${question}` }] }]
                    })
                });
                
                const data = await response.json();
                chat.removeChild(loading);
                const answer = data.candidates?.[0]?.content?.parts?.[0]?.text || "ุนุฐุฑุงูุ ูู ุฃุณุชุทุน ุชุญููู ุงูุณุคุงู.";
                chat.innerHTML += `<div class="chat-msg ai-msg">${answer}</div>`;
            } catch (e) {
                chat.removeChild(loading);
                chat.innerHTML += `<div class="chat-msg ai-msg text-red-500">ุญุฏุซ ุฎุทุฃ. ูุฑุฌู ุงูุชุฃูุฏ ูู ุฃู ุงูููุชุงุญ ุงููุดูุฑ ุชู ูุถุนู ุจุดูู ุตุญูุญ ูู ุงูููุฏ.</div>`;
            }
            chat.scrollTop = chat.scrollHeight;
        }

        // --- ูุธุงู ุงูุงุฎุชุจุงุฑ ---
        function loadQuestion() {
            const q = QUESTIONS[state.q];
            document.getElementById('quiz-progress').textContent = `ุงูุณุคุงู ${state.q + 1} ูู ${QUESTIONS.length}`;
            document.getElementById('question-text').textContent = q.q;
            const area = document.getElementById('options-area');
            area.innerHTML = "";
            q.opts.forEach((opt, i) => {
                const b = document.createElement('button');
                b.className = "quiz-btn";
                b.textContent = opt;
                b.onclick = () => checkAns(i, b);
                area.appendChild(b);
            });
        }

        function checkAns(idx, btn) {
            const btns = document.querySelectorAll('.quiz-btn');
            btns.forEach(b => b.disabled = true);
            if (idx === QUESTIONS[state.q].ans) {
                btn.classList.add('correct');
                state.score++;
                document.getElementById('quiz-score').textContent = state.score;
            } else {
                btn.classList.add('wrong');
                btns[QUESTIONS[state.q].ans].classList.add('correct');
            }
            setTimeout(() => {
                state.q++;
                if (state.q < QUESTIONS.length) loadQuestion();
                else endQuiz();
            }, 1200);
        }

        function endQuiz() {
            clearInterval(state.timer);
            document.getElementById('quiz-area').style.display = 'none';
            document.getElementById('result-area').classList.add('active');
            document.getElementById('final-score').textContent = state.score;
            document.getElementById('result-title').textContent = state.score >= 16 ? "ุฃุฏุงุก ูุชููุฒ ุฌุฏุงู!" : (state.score >= 10 ? "ุฃุฏุงุก ุฌูุฏุ ูุงุตู ุงููุฑุงุฌุนุฉ" : "ุชุญุชุงุฌ ููุฑุงุฌุนุฉ ุงูุฏุฑุณ ุจุชุฑููุฒ ุฃูุจุฑ");
            
            // ุฅุฑุณุงู ุงูุจูุงูุงุช ูุฌูุฌู ููุฑู
            const form = document.createElement('form');
            form.action = GOOGLE_FORM_URL; form.method = "POST"; form.target = "hidden_iframe";
            const data = { [ENTRIES.name]: state.name, [ENTRIES.score]: state.score, [ENTRIES.extra]: `ุงูุฒูู ุงููุณุชุบุฑู: ${state.timeStr}` };
            for(let k in data) { const i = document.createElement('input'); i.name = k; i.value = data[k]; form.appendChild(i); }
            document.body.appendChild(form); form.submit();
        }
    </script>
</body>
</html>
