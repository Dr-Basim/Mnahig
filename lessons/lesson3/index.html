<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุงูุฎูุงุตุฉ ูู ุงูุจุญุซ ุงูุนููู | ุงููุญุงุถุฑุฉ ุงูุซุงููุฉ</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --navy: #1a1a2e;
            --gold: #e2b96f;
            --cream: #faf8f3;
            --purple: #7c3aed;
        }

        body { 
            font-family: 'Cairo', sans-serif; 
            background-color: var(--cream); 
            color: var(--navy);
            margin: 0; padding: 0; line-height: 1.8;
        }

        .font-serif { font-family: 'Amiri', serif; }

        #welcome-screen {
            position: fixed; inset: 0; background: var(--navy);
            display: flex; justify-content: center; align-items: center; z-index: 2000;
        }

        nav {
            background: white; border-bottom: 2px solid #e5e7eb;
            display: flex; justify-content: center; position: sticky; top: 0; z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .nav-btn {
            padding: 1.5rem 2rem; font-weight: bold; color: #6b7280;
            border-bottom: 4px solid transparent; transition: 0.3s;
            cursor: pointer; white-space: nowrap; font-size: 1.1rem;
        }
        .nav-btn.active { color: var(--navy); border-bottom-color: var(--gold); }

        /* Trait Cards */
        .trait-card {
            border-radius: 1.5rem; padding: 2rem; margin-bottom: 1.5rem;
            display: flex; align-items: center; gap: 1.5rem;
            transition: 0.3s; border: 1px solid rgba(0,0,0,0.05);
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
        }
        .trait-icon {
            width: 70px; height: 70px; border-radius: 1.2rem;
            display: flex; align-items: center; justify-content: center;
            font-size: 2rem; background: white; flex-shrink: 0;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* Flashcards */
        .flash-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 768px) { .flash-grid { grid-template-columns: repeat(2, 1fr); } }
        .flash-card { height: 280px; perspective: 1000px; cursor: pointer; }
        .flash-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; }
        .flash-card.flipped .flash-inner { transform: rotateY(180deg); }
        .front, .back { position: absolute; inset: 0; backface-visibility: hidden; border-radius: 1.5rem; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 25px; text-align: center; box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
        .front { background: white; border: 3px solid var(--gold); color: var(--navy); }
        .back { background: var(--navy); color: white; transform: rotateY(180deg); border: 3px solid var(--gold); overflow-y: auto; }

        /* Map */
        .map-branch {
            background: white; border: 3px solid var(--navy);
            padding: 1.5rem; border-radius: 1.5rem;
            width: 100%; min-width: 300px; box-shadow: 0 8px 15px rgba(0,0,0,0.05);
        }
        .sub-key {
            background: #f9fafb; border: 1px solid #e5e7eb;
            padding: 0.4rem 0.8rem; border-radius: 0.75rem;
            font-size: 0.85rem; font-weight: 700; color: var(--navy);
        }

        /* Quiz */
        .question-box {
            background: var(--navy); color: white; border-radius: 1.2rem;
            padding: 2.5rem; margin-bottom: 2rem; border-right: 10px solid var(--gold);
        }
        .opt-btn { 
            width: 100%; text-align: right; padding: 1.25rem; border: 2px solid #e5e7eb; 
            border-radius: 1rem; margin-bottom: 1rem; transition: 0.3s; 
            font-weight: bold; background: white; font-size: 1.1rem;
        }
        .opt-btn.correct { background: #ecfdf5 !important; border-color: #10b981 !important; color: #065f46; }
        .opt-btn.wrong { background: #fef2f2 !important; border-color: #ef4444 !important; color: #991b1b; }

        #chat-window { height: 500px; overflow-y: auto; border: 2px solid #e5e7eb; border-radius: 1.2rem; padding: 1.5rem; background: #fff; display: flex; flex-direction: column; gap: 1rem; }
        .msg { padding: 1rem 1.5rem; border-radius: 1.2rem; max-width: 85%; }
        .ai-msg { background: #f3f4f6; align-self: flex-start; border-bottom-right-radius: 0; }
        .user-msg { background: var(--navy); color: #fff; align-self: flex-end; border-bottom-left-radius: 0; }

        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .section-title { font-family: 'Amiri', serif; font-size: 2.5rem; font-weight: bold; border-bottom: 4px solid var(--gold); display: inline-block; margin-bottom: 2rem; }
    </style>
</head>
<body>

    <!-- Welcome Screen -->
    <div id="welcome-screen">
        <div class="bg-white p-10 rounded-3xl text-center max-w-lg w-11/12 border-t-8 border-[#e2b96f] shadow-2xl">
            <h1 class="font-serif text-5xl font-bold text-[#1a1a2e] mb-2">ุงููุญุงุถุฑุฉ ุงูุซุงููุฉ</h1>
            <h2 class="text-2xl text-[#e2b96f] mb-8 font-bold text-center">ุงูุจุงุญุซุ ูุตูุงุชูุ ูุงูุฅุดุฑุงู ุงูุนููู</h2>
            <input type="text" id="student-name-input" class="w-full p-5 border-2 rounded-2xl text-center text-2xl mb-6 outline-none focus:border-[#e2b96f]" placeholder="ุฃุฏุฎู ุงุณูู ุงูุฑุจุงุนู...">
            <button onclick="app.start()" class="w-full bg-[#1a1a2e] text-[#e2b96f] p-5 rounded-2xl text-2xl font-black hover:scale-105 transition transform shadow-xl">ุฏุฎูู ุงููุญุงุถุฑุฉ</button>
        </div>
    </div>

    <!-- Main Content -->
    <div id="main-app" class="screen">
        <header class="bg-[#1a1a2e] text-white p-5 flex justify-between items-center sticky top-0 z-50 shadow-xl">
            <div class="font-serif text-3xl font-bold text-[#e2b96f]">ุงูุฎูุงุตุฉ ูู ุงูุจุญุซ ุงูุนููู</div>
            <div class="flex gap-4 items-center">
                <div class="bg-white/10 px-6 py-2 rounded-full text-sm border border-white/20">
                    ุงูุทุงูุจ: <span id="header-name" class="text-[#e2b96f] font-bold"></span>
                </div>
                <div class="bg-white/10 px-6 py-2 rounded-full text-sm border border-white/20">
                    ุงูุฒูู: <span id="header-timer" class="text-[#e2b96f] font-bold">00:00</span>
                </div>
            </div>
        </header>

        <nav>
            <button class="nav-btn active" onclick="app.switchTab('content', this)">๐ ุงููุงุฏุฉ ุงูุนูููุฉ</button>
            <button class="nav-btn" onclick="app.switchTab('map', this)">๐ฟ ุงูุฎุฑูุทุฉ ุงูุจุตุฑูุฉ</button>
            <button class="nav-btn" onclick="app.switchTab('review', this)">๐ก ุงููุฑุงุฌุนุฉ ุงูุฐููุฉ</button>
            <button class="nav-btn" style="color:var(--purple)" onclick="app.switchTab('ai', this)">โจ ุงููุณุงุนุฏ ุงูุฐูู</button>
            <button class="nav-btn" onclick="app.switchTab('quiz', this)">๐ ุงูุงุฎุชุจุงุฑ ุงูููุงุฆู</button>
        </nav>

        <main class="max-w-6xl mx-auto p-6 md:p-10">
            <!-- Content Tab -->
            <section id="tab-content" class="screen active">
                <div class="bg-white rounded-3xl p-10 shadow-lg border-r-[12px] border-[#1a1a2e] mb-12">
                    <h2 class="section-title">ุฃููุงู: ููููู ุงูุจุงุญุซ ุงูุฃุตูู</h2>
                    <p class="text-2xl leading-relaxed text-justify mb-6">ูู ุงูุดุฎุต ุงูุฐู ุชูุงูุฑุช ููู ุงูุงุณุชุนุฏุงุฏุงุช ุงููุทุฑูุฉ ูุงูููุณูุฉ ูุงูุนูููุฉ ุงูุชู ุชุคููู ููููุงู ุจุจุญุซ ุนููู.</p>
                    <div class="bg-[#faf8f3] p-6 rounded-2xl border-2 border-dashed border-[#e2b96f]">
                        <p class="text-2xl font-bold text-[#1a1a2e]">ุงูุจุงุญุซ ุงูุฃุตูู: ูู ุงูุฐู ูุชุทูุน ุฅูู ุงููุฌูููุ ููุจุญุซ ุนู ุงูุฌุฏูุฏุ ููุชููุฒ ุจุงููุฑููุฉ ุงูููุฑูุฉุ ูููุชูู ุงููุฏุฑุฉ ุนูู ุชูุธูู ุงููุนูููุงุช ูู ุฃุณููุจ ุนููู ุฑุตูู ูููุธู.</p>
                    </div>
                </div>
                <h2 class="section-title">ุซุงููุงู: ุตูุงุช ุงูุจุงุญุซ (14 ุตูุฉ ุชูุตูููุฉ)</h2>
                <div id="traits-list" class="flex flex-col gap-6"></div>
                <div class="bg-[#1a1a2e] text-white rounded-3xl p-12 mt-16 border-t-8 border-[#e2b96f] shadow-2xl">
                    <h2 class="font-serif text-4xl font-bold mb-8 text-[#e2b96f]">ุซุงูุซุงู: ุงูุฅุดุฑุงู ุงูุนููู (ูููุฉ ุตูุงุนุฉ ุงูุจุงุญุซูู)</h2>
                    <p class="text-2xl leading-relaxed mb-8">ูู ุชูุฌูู ุฃุณุชุงุฐ ูุชุฎุตุต ุทุงูุจ ุงูุจุญุซ ุฅูู ุงููููุฌ ุงูุนููู ุงูุณููู. ุงูุฅุดุฑุงู <span class="text-[#e2b96f] font-black underline">ููุณ ุนููุงู ุฅุฏุงุฑูุงู ุจุญุชุงู</span>ุ ุจู ูู ูููุฉ ุตุนุจุฉ <span class="text-[#e2b96f] font-black">ุชุตูุน ุงูุจุงุญุซูู</span>.</p>
                </div>
            </section>

            <!-- Map Tab -->
            <section id="tab-map" class="screen">
                <div class="bg-white rounded-3xl p-10 shadow-xl border-2">
                    <h2 class="section-title w-full text-center">ุฎุฑูุทุฉ ููุงุชูุญ ุงููุญุงุถุฑุฉ ุงูุซุงููุฉ</h2>
                    <div class="flex flex-col items-center">
                        <div class="bg-[#1a1a2e] text-[#e2b96f] p-8 rounded-2xl font-bold text-3xl shadow-xl border-4 border-[#e2b96f] mb-10">ุฃุฑูุงู ุงูุนูููุฉ ุงูุจุญุซูุฉ</div>
                        <div class="flex flex-col lg:flex-row justify-between w-full gap-10">
                            <div class="map-branch flex-1 bg-blue-50/50">
                                <h3 class="font-black text-2xl mb-4 border-b-2 border-navy pb-2">๐ ุงูุจุงุญุซ ุงูุฃุตูู</h3>
                                <div class="grid grid-cols-1 gap-2"><span class="sub-key">๐น ุงุณุชุนุฏุงุฏ ูุทุฑู</span><span class="sub-key">๐น ุชุฃููู ุนููู</span><span class="sub-key">๐น ุชุทูุน ูููุฌููู</span><span class="sub-key">๐น ูุฑููุฉ ููุฑูุฉ</span></div>
                            </div>
                            <div class="map-branch flex-[1.5] bg-amber-50/50" style="border-color: var(--gold);">
                                <h3 class="font-black text-2xl mb-4 border-b-2 border-gold pb-2">โญ ุตูุงุช ุงูุจุงุญุซ (ูกูค)</h3>
                                <div id="map-traits-grid" class="grid grid-cols-2 md:grid-cols-3 gap-2"></div>
                            </div>
                            <div class="map-branch flex-1 bg-emerald-50/50">
                                <h3 class="font-black text-2xl mb-4 border-b-2 border-navy pb-2">๐จโ๐ซ ุงูุฅุดุฑุงู ุงูุนููู</h3>
                                <div class="flex flex-col gap-2"><span class="sub-key">โ ุชูุฌูู ูุชุฎุตุต</span><span class="sub-key">โ ุตูุงุนุฉ ุจุงุญุซูู</span><span class="sub-key">โ ุชูุงุถุน ูุญูู</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Review Tab -->
            <section id="tab-review" class="screen">
                <h2 class="section-title">ุจูู ูุฑุงุฌุนุฉ ุงููุญุงุถุฑุฉ ุงูุดุงูู</h2>
                <div id="flash-container" class="flash-grid"></div>
            </section>

            <!-- AI Tab -->
            <section id="tab-ai" class="screen">
                <div class="bg-white rounded-3xl p-10 border-r-[12px] border-purple-600 shadow-2xl">
                    <h2 class="font-serif text-3xl font-bold mb-6 text-purple-700">โจ ุงููุณุงุนุฏ ุงูุฃูุงุฏููู ุงูุฐูู (Gemini)</h2>
                    <div id="chat-window"></div>
                    <div class="flex gap-4 mt-6">
                        <input type="text" id="chat-input" class="flex-1 p-5 border-2 rounded-2xl outline-none focus:border-purple-500 text-lg" placeholder="ุงุณุฃููู ุนู ุฃู ุฌุฒุฆูุฉ ูู ุงููุญุงุถุฑุฉ...">
                        <button onclick="app.askAI()" class="bg-purple-600 text-white px-10 rounded-2xl font-black text-xl hover:bg-purple-700 transition">ุฅุฑุณุงู</button>
                    </div>
                </div>
            </section>

            <!-- Quiz Tab -->
            <section id="tab-quiz" class="screen">
                <div id="quiz-box">
                    <div class="bg-white rounded-3xl p-10 shadow-2xl border-2">
                        <div class="flex justify-between items-center mb-10 pb-6 border-b-2">
                            <span id="quiz-progress" class="font-black text-2xl text-gray-400">ุงูุณุคุงู 1 ูู 20</span>
                            <div class="bg-[#e2b96f] text-[#1a1a2e] px-6 py-2 rounded-full font-black text-xl">ุงูุฏุฑุฌุฉ: <span id="quiz-score-display">0</span></div>
                        </div>
                        <div class="question-box"><h3 id="quiz-question-text" class="text-3xl font-bold"></h3></div>
                        <div id="quiz-options-grid" class="grid grid-cols-1 gap-4"></div>
                    </div>
                </div>
                <div id="quiz-final-result" class="hidden bg-white rounded-3xl p-20 text-center shadow-2xl border-t-[15px] border-[#1a1a2e]">
                    <div class="text-9xl mb-10">๐</div>
                    <h2 id="final-result-title" class="text-5xl font-black mb-6"></h2>
                    <p id="final-result-score" class="text-8xl font-black text-[#e2b96f] mb-12"></p>
                    <div class="p-8 bg-green-50 text-green-700 rounded-3xl font-black text-2xl inline-block border-4 border-green-500 shadow-xl">โ ุชู ุงุนุชูุงุฏ ูุชูุฌุชู ูุฅุฑุณุงู ุงูุจูุงูุงุช ุจูุฌุงุญ.</div>
                </div>
            </section>
        </main>
    </div>

    <script>
        const apiKey = "QUl6YVN5QndlRnVud0dyWkdEeHRyb2FyQlotUVhkMWJXVUFJU2JV"; // ูุชุฑู ูุงุฑุบุงู ููุง ูู ุงูุฅุฑุดุงุฏุงุช
        const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSfdYy7qS_r7pP9BFVY2aVKSrZpZk3Vh1S4PoP-2CId16cP6Zg/formResponse";
        const ENTRIES = { name: "entry.1250768814", score: "entry.289736692", time: "entry.809300628" };

        const LESSON_DATA = {
            traits: [
                {n: "ูก. ุงูุฑุบุจุฉ", k: "(ุงูุฏุงูุน)", d: "ูุฌุจ ุชููููุง ุฅุฐุง ูู ุชูุฌุฏุ ูุดุนูุฑ ุงูุจุงุญุซ ุจุงูุซูุฑุฉ ุงูุญุงุถุฑุฉ ูุงููุณุชูุจูุฉ.", c: "#E0F2F1", i: "๐ฅ"},
                {n: "ูข. ุงูุตุจุฑ", k: "(ุงููููุฏ)", d: "ูููุฏ ุงูุจุงุญุซ ุงูุฐู ูุง ููุถุจุ ููุตุจุฑ ุนูู ุงููุฑุงุฌุน ูุงูุฃุณูุงุฑ ูุงููุดุฑู.", c: "#FFF3E0", i: "โณ"},
                {n: "ูฃ. ุงูุฅูุตุงู", k: "(ุงูุฃูุงูุฉ)", d: "ุงูุฃูุงูุฉ ูู ุงูููู ูุชุฑู ุงููููุ ููุง ูุบูุจ ุนููู ุบุถุจ ุฃู ุฑุถุง ุนูุฏ ุงูุชูููู.", c: "#F3E5F5", i: "โ๏ธ"},
                {n: "ูค. ุณูุงูุฉ ุงูุฐูู", k: "(ุงูุฃุฏุจ)", d: "ุฅุญุณุงู ุงูููุฏ ุจุนูุฏุงู ุนู ุงูุงุณุชูุฒุงุฒ ูุงูุนุจุงุฑุงุช ุงูุฌุงููุฉ ุงูููุญุดุฉ.", c: "#E1F5FE", i: "๐๏ธ"},
                {n: "ูฅ. ุงูุนูููุฉ ุงูููุธูุฉ", k: "(ุงูุชุฑุชูุจ)", d: "ุงูุจุญุซ ูุง ููุถู ูููุ ุจู ุชุจููุจ ุญุณู ูุนูู ูุชูุงุณู ููุฑุชุจ.", c: "#F1F8E9", i: "๐"},
                {n: "ูฆ. ุนูู ุงูุชูููุฑ", k: "(ุงูุชุฃูู)", d: "ุงูุบูุต ูู ุญูุงุฆู ุงูุฃููุฑุ ููููุตุญ ุจุญูู ููู ููุฑูุฉ ูุชูููุฏ ุงูุฎูุงุทุฑ.", c: "#FFF8E1", i: "๐ง"},
                {n: "ูง. ุงููุทูุฉ", k: "(ุงูุฏูุฉ)", d: "ุงูุชูุจู ููู ุตุบูุฑุฉ ููุจูุฑุฉ ูุถูุงู ุชุฑุงุจุท ุฃุฌุฒุงุก ุงูุจุญุซ ูููุชู.", c: "#E8EAF6", i: "๐"},
                {n: "ูจ. ุงูุดู ุงูุนููู", k: "(ุงูุชุซุจุช)", d: "ูุฒู ุงูุฃููุฑ ุจููุฒุงู ุฏููู ูุจู ูุจูููุงุ ููู ูุฎุชูู ุนู ุงูุดู ุงููุฑุถู.", c: "#FCE4EC", i: "๐"},
                {n: "ูฉ. ุงููุจุงุฏุฑุฉ", k: "(ุงูุงูุชูุงุฒ)", d: "ุงูุชูุงุฒ ุงููุฑุต ูุงูุณุฑุนุฉ ุงูุชู ุชุนูู ุนุฏู ุงูุชุจุงุทุคุ ูุง ุงูุนุฌูุฉ ุงููุฐูููุฉ.", c: "#EFEBE9", i: "๐"},
                {n: "ูกู. ุงูุญุงูุธุฉ ุงููุงุนูุฉ", k: "(ุงูุฐุงูุฑุฉ)", d: "ุงููุฏุฑุฉ ุนูู ุฑุจุท ุงููุฏูู ุจุงูุฌุฏูุฏ ูููุน ุชุดุชุช ุงูุจุญุซ ูุชูุฑุงุฑู.", c: "#F9FBE7", i: "๐พ"},
                {n: "ูกูก. ูุชุงุจุนุฉ ุงูุฌุฏูุฏ", k: "(ุงูุงุทูุงุน)", d: "ุงูุงุทูุงุน ุงูุฏุงุฆู ูู ููุฏุงู ุงูุชุฎุตุตุ ูุฆูุง ููุชุจ ูููุง ุจูุญุซ ุณุงุจูุงู.", c: "#E0F7FA", i: "๐"},
                {n: "ูกูข. ุงูุงุณุชูุชุงุน ุจุงูุจุญุซ", k: "(ุงููุฐุฉ)", d: "ูุฐุฉ ุนูููุฉ ุชููู ุงููุฐุงุช ุงูุญุณูุฉุ ูุงู ุงูุดุงูุนู: ุณูุฑู ูุชูููุญ ุงูุนููู ุฃูุฐ ูู.", c: "#FFFDE7", i: "โญ"},
                {n: "ูกูฃ. ูุฒูู ุงูุชูุงุถุน", k: "(ุงูุณูู)", d: "ุฅูุจุงุฑ ุงูุนููุงุก ูุงูุชุถุงู ุงูููุณุ ููููุง ุฒุงุฏ ุนููุงู ุฒุงุฏ ุนููุงู ุจุฌููู.", c: "#F5F5F5", i: "๐"},
                {n: "ูกูค. ุงูุชูุงุณ ุงูุจุฑูุฉ", k: "(ุงูููุฉ)", d: "ุจุณูุงูุฉ ุงูููุฉ ูุฅุนุงูุฉ ุงูุฒููุงุกุ ููููู: ุงููู ูู ุนูู ุงูุนุจุฏ ูุง ูุงู ุงูุนุจุฏ ูู ุนูู ุฃุฎูู.", c: "#E8F5E9", i: "โจ"}
            ],
            questions: [
                {q: "ูู ูู ุงูุจุงุญุซ ุงูุฃุตููุ", o: ["ุงูุญุงูุธ ูููุชุจ", "ุงููุชุทูุน ูููุฌููู ูุงูุฌุฏูุฏ", "ุงูููุชูู ุจุงููุตุงุฏุฑ ุงููุฏููุฉ", "ุงููููู ููุจุญุซ ุจุณุฑุนุฉ"], a: 1},
                {q: "ูุง ูู 'ูููุฏ ุงูุจุงุญุซ'ุ", o: ["ุงููุงู", "ุงูุฑุบุจุฉ", "ุงูุตุจุฑ", "ุงููุดุฑู"], a: 2},
                {q: "ููู ููุชูุณ ุงูุจุงุญุซ ุงูุจุฑูุฉุ", o: ["ุจุงูุนุฒูุฉ", "ุจุฅุฎูุงุก ุงููุนูููุงุช", "ุจุฅุนุงูุฉ ุงูุฒููุงุก ูุณูุงูุฉ ุงูููุฉ", "ุจุงูุณูุฑ"], a: 2},
                {q: "ุงูุฅุดุฑุงู ุงูุนููู ููุฏู ูู:", o: ["ุงูุฅุฏุงุฑุฉ", "ุตูุงุนุฉ ุงูุจุงุญุซูู", "ุชุตุญูุญ ุงูุฅููุงุก", "ูุฑุงูุจุฉ ุงูููุช"], a: 1},
                {q: "ุณูุงูุฉ ุงูุฐูู ุชุนูู:", o: ["ุงูููุงููุฉ", "ุชุฌูุจ ุงูุนุจุงุฑุงุช ุงูุฌุงููุฉ", "ุงูููุฏ ุงููุงุณู", "ุนุฏู ุงูููุฏ"], a: 1}
            ]
        };

        const app = {
            state: { name: "", score: 0, currentQ: 0, start: 0, timeStr: "00:00", timer: null },

            start() {
                const name = document.getElementById('student-name-input').value.trim();
                if (name.split(/\s+/).length < 3) return alert("ูุฑุฌู ุฅุฏุฎุงู ุงุณูู ุงูุฑุจุงุนู");
                this.state.name = name;
                document.getElementById('header-name').textContent = name;
                document.getElementById('welcome-screen').style.display = 'none';
                document.getElementById('main-app').classList.add('active');
                this.state.start = Date.now();
                this.init();
            },

            init() {
                document.getElementById('traits-list').innerHTML = LESSON_DATA.traits.map(t => `
                    <div class="trait-card" style="background-color: ${t.c}">
                        <div class="trait-icon">${t.i}</div>
                        <div><h4 class="font-black text-2xl mb-1">${t.n}</h4><p class="text-xl text-gray-800">${t.d}</p></div>
                    </div>`).join('');
                document.getElementById('map-traits-grid').innerHTML = LESSON_DATA.traits.map(t => `<span class="sub-key">๐ ${t.n.split('.')[1]}</span>`).join('');
                document.getElementById('flash-container').innerHTML = LESSON_DATA.traits.map(t => `
                    <div class="flash-card" onclick="this.classList.toggle('flipped')">
                        <div class="flash-inner">
                            <div class="front"><h4 class="text-2xl font-bold">ูุง ุงูููุตูุฏ ุจู ${t.n}ุ</h4></div>
                            <div class="back"><p class="text-xl">${t.d}</p></div>
                        </div>
                    </div>`).join('');
                this.loadQuestion();
                this.state.timer = setInterval(() => {
                    const diff = Math.floor((Date.now() - this.state.start) / 1000);
                    this.state.timeStr = `${Math.floor(diff/60).toString().padStart(2, '0')}:${(diff%60).toString().padStart(2, '0')}`;
                    document.getElementById('header-timer').textContent = this.state.timeStr;
                }, 1000);
            },

            switchTab(id, btn) {
                document.querySelectorAll('main > section').forEach(s => s.classList.remove('active'));
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('tab-' + id).classList.add('active');
                btn.classList.add('active');
            },

            loadQuestion() {
                const q = LESSON_DATA.questions[this.state.currentQ % LESSON_DATA.questions.length];
                document.getElementById('quiz-progress').textContent = `ุงูุณุคุงู ${this.state.currentQ + 1} ูู 20`;
                document.getElementById('quiz-question-text').textContent = q.q;
                document.getElementById('quiz-options-grid').innerHTML = q.o.map((o, i) => `<button class="opt-btn" onclick="app.checkAnswer(${i}, this)">${o}</button>`).join('');
            },

            checkAnswer(idx, btn) {
                const q = LESSON_DATA.questions[this.state.currentQ % LESSON_DATA.questions.length];
                document.querySelectorAll('.opt-btn').forEach(b => b.disabled = true);
                if (idx === q.a) { btn.classList.add('correct'); this.state.score++; document.getElementById('quiz-score-display').textContent = this.state.score; }
                else { btn.classList.add('wrong'); document.querySelectorAll('.opt-btn')[q.a].classList.add('correct'); }
                setTimeout(() => { this.state.currentQ++; if (this.state.currentQ < 20) this.loadQuestion(); else this.finishQuiz(); }, 1200);
            },

            async askAI() {
                const input = document.getElementById('chat-input');
                const box = document.getElementById('chat-window');
                const query = input.value.trim();
                if (!query) return;
                box.innerHTML += `<div class="msg user-msg">${query}</div>`;
                input.value = ""; box.scrollTop = box.scrollHeight;
                const loading = document.createElement('div');
                loading.className = "msg ai-msg italic"; loading.textContent = "ุฌุงุฑู ุงูุงุชุตุงู ุจู Gemini...";
                box.appendChild(loading); box.scrollTop = box.scrollHeight;

                const system = "ุฃูุช ูุณุงุนุฏ ุชุนูููู ูููุญุงุถุฑุฉ ุงูุซุงููุฉ ูู ุงูุจุญุซ ุงูุนููู (ุงูุจุงุญุซ ูุงูุฅุดุฑุงู). ุงุดุฑุญ ููุทุงูุจ ุจุฃุณููุจ ุฃูุงุฏููู.";
                
                const fetchAI = async (retries = 5, delay = 1000) => {
                    for (let i = 0; i < retries; i++) {
                        try {
                            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    contents: [{ parts: [{ text: query }] }],
                                    systemInstruction: { parts: [{ text: system }] }
                                })
                            });
                            if (!res.ok) throw new Error();
                            const data = await res.json();
                            return data.candidates?.[0]?.content?.parts?.[0]?.text;
                        } catch (e) {
                            if (i === retries - 1) throw e;
                            await new Promise(r => setTimeout(r, delay));
                            delay *= 2;
                        }
                    }
                };

                try {
                    const reply = await fetchAI();
                    box.removeChild(loading);
                    box.innerHTML += `<div class="msg ai-msg">${reply || "ูู ุฃุณุชุทุน ูุนุงูุฌุฉ ุงูุฑุฏ."}</div>`;
                } catch (e) {
                    box.removeChild(loading);
                    box.innerHTML += `<div class="msg ai-msg text-red-500">ุญุฏุซ ุฎุทุฃ ูู ุงูุงุชุตุงู. ูุฑุฌู ุงููุญุงููุฉ ูุงุญูุงู.</div>`;
                }
                box.scrollTop = box.scrollHeight;
            },

            async finishQuiz() {
                if (this.state.timer) clearInterval(this.state.timer);
                document.getElementById('quiz-box').style.display = 'none';
                document.getElementById('quiz-final-result').classList.remove('hidden');
                document.getElementById('final-result-score').textContent = `${this.state.score} / 20`;
                document.getElementById('final-result-title').textContent = this.state.score >= 15 ? "ุฃูุช ุจุงุญุซ ูุชููู!" : "ุฃุฏุงุก ุฌูุฏุ ูุงุตู ุงููุฑุงุฌุนุฉ";

                // ุฅุฑุณุงู ุงูุจูุงูุงุช ุจุงุณุชุฎุฏุงู Fetch ู FormData ูุถูุงู ูุตูู ุงูุงุณู ูุงูุฏุฑุฌุฉ
                const formData = new FormData();
                formData.append(ENTRIES.name, this.state.name);
                formData.append(ENTRIES.score, this.state.score.toString());
                formData.append(ENTRIES.time, this.state.timeStr);

                try {
                    await fetch(FORM_URL, { method: "POST", body: formData, mode: "no-cors" });
                } catch (e) { console.error("Form Error"); }
            }
        };
    </script>
</body>
</html>
